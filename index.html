<!DOCTYPE html>
<!--
 * jsClock - A simple digital clock with pomodoro timer (one page version)
 * Copyright (c) 2017-2025 Silvino R.
 * @license MIT
 * @see https://github.com/silvinor/jsclock
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>Clock</title>
	<meta http-equiv="refresh" content="12960"><!-- refresh every 3.6-hours (200 times per 30 days) -->
  <meta name="color-scheme" content="dark">

  <link rel="icon" type="image/gif" href="favicon.gif">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/svg+xml" id="favicon">
  <link rel="manifest" href="site.webmanifest">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=PT+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

  <style>
    :root {
      color-scheme: dark;

      --font-root: Inter, system-ui, sans-serif;
      --font-fancy: Raleway, serif;
      --font-serif: "PT Serif", serif;

      font-family: var(--font-root);
      font-feature-settings: 'liga' 1, 'calt' 1; /* fix for Chrome */
      font-style: normal;

      /* Digital */
      --clock-font: var(--font-fancy);
      --time-color: #ed0;
      --seconds-color: #ddd;
      --ampm-color: #777a;
      --date-color: #09ca;

      /* Analog */
      --anlg-hmrk: #444;
      --anlg-mmrk: #444;
      --anlg-hour: #222e;
      --anlg-mins: #222e;
      --anlg-secs: #a35e;
      --anlg-name: #146e;
      --anlg-time: #333;
      --anlg-fill: #aaa;

      /* Pomodoro */
      --pd-inactive-color: #5555;
      --pd-rest-rem-color: #a35a;
      --pd-rest-cur-color: #e94a;
      --pd-work-rem-color: #4d8a;
      --pd-work-cur-color: #36ba;
    }
    @supports (font-variation-settings: normal) {
      :root { 
        --font-root: InterVariable, system-ui, sans-serif;
      }
    }    

    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      /* Stack elements vertically */
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #111;
      color: #eee;
      cursor: none;
    }

    a {
      color: inherit;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    /* Digital Clock */

    #digital-clock {
      width: 75%;
      height: auto;
      pointer-events: none;
    }

    #time-str .separator { transition: opacity 0.25s ease; }
    #time-str.odd .separator { opacity: 0.01; }
    #time-str.even .separator { opacity: 1; }

    /* Analog Clock */

    #analog-clock {
      width: 66.667%;
      height: auto;
      max-height: 66.667%;
      filter: drop-shadow(0 0 50px rgba(127, 127, 127, 0.5));
    }

    .hour-marker { stroke: var(--anlg-hmrk); }
    .minute-marker { stroke: var(--anlg-mmrk); }
    .hour-hand { stroke: var(--anlg-hour); stroke-width: 3; }
    .minute-hand { stroke: var(--anlg-mins); stroke-width: 2.25; }
    .second-hand { stroke: var(--anlg-secs); stroke-width: 1.5; }
    .face-seconds {
      font-family: var(--font-serif);
      font-size: 8px;
      font-weight: 400;
    }
    #face-name {
      font-family: var(--font-serif);
      font-size: 10px;
      font-weight: 900;
      fill: var(--anlg-name);
    }
    #date {
      opacity: 0.667;
    }
    #date #dow-str,
    #date #day-str,
    #date #mth-str {
      font-family: var(--font-serif);
      font-size: 10px;
      font-weight: 400;
    }

    /* Footer */

    #footer {
      display: block;
      position: fixed;
      bottom: 0;
      width: 100%;
      text-align: center;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      color: rgba(221, 221, 221, 0.75); /* #ddd */
      opacity: 0;
      visibility: hidden;
      transition: opacity 2s ease-in-out, visibility 2s ease-in-out;
      z-index: 99;
    }

    #footer.show {
      opacity: 1;
      visibility: visible;
      display: block;
    }

    input[type="text"],
    input[type="number"] {
      background-color: transparent;
      border: 1px solid rgba(127, 127, 127, 0.25);
      color: inherit;
      font-family: inherit;
      font-size: 0.75rem;
      padding: 2px 5px;
      outline: none;
      transition: border-color 0.3s ease;
    }
    input[type="text"] {
      width: 8rem;
    }
    input[type="number"] {
      width: 2.25rem;
    }
    input::placeholder {
      color: rgba(127, 127, 127, 0.25);
    }
    input:focus {
      border-bottom-color: rgba(127, 127, 127, 0.5);
    }
    label.small {
      font-size: 0.75rem;
    }
    input:focus,
    textarea:focus,
    select:focus {
      box-shadow: 0 0 6px 2px rgba(0, 150, 250, 0.4);
    }

    body,
    #digital-clock,
    #analog-clock,
    #footer {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
    }

    .hide { display: none; }
  </style>
</head>
<body class="digital">
  <!-- Digital clock -->
  <svg id="digital-clock" class="show" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 120">
    <g font-family="var(--clock-font, inherit)">
      <text id="time-str" x="5" y="40" text-anchor="begin" dominant-baseline="middle" font-size="85" fill="var(--time-color)" font-weight="700"><tspan id="hour-str">00</tspan><tspan class="separator">:</tspan><tspan id="mins-str">00</tspan></text>
      <text id="secs-str" x="230" y="25" text-anchor="begin" dominant-baseline="middle" font-size="55" fill="var(--seconds-color)" font-weight="700">00</text>
      <text id="hr12-str" x="230" y="65" text-anchor="begin" dominant-baseline="middle" font-size="35" fill="var(--ampm-color)" font-weight="400">am</text>
    </g>
    <g font-family="inherit">
      <text id="date-str" x="0" y="108" font-size="32" fill="var(--date-color)" font-weight="400" textLength="300" lengthAdjust="spacingAndGlyphs">If you see this, it's broken!</text>
    </g>
    <g id="pomodoro" stroke="none">
      <rect id="pd5" x="200" y="118" width="100" height="2" fill="var(--pd-inactive-color)" visibility="hidden"/>
      <rect id="pd4" x="150" y="118" width="50" height="2" fill="var(--pd-rest-rem-color)" visibility="hidden"/>
      <rect id="pd3" x="100" y="118" width="50" height="2" fill="var(--pd-rest-cur-color)" visibility="hidden"/>
      <rect id="pd2" x="50" y="118" width="50" height="2" fill="var(--pd-work-rem-color)" visibility="hidden"/>
      <rect id="pd1" x="0" y="118" width="50" height="2" fill="var(--pd-work-cur-color)" visibility="hidden"/>
    </g>
  </svg>
  <!-- Analog clock -->
  <svg id="analog-clock" class="hide" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
    <defs>
      <linearGradient id="g1" x1="100%" y1="0%" x2="0%" y2="0%">
        <stop offset="0%" stop-color="#bbb"/>
        <stop offset="100%" stop-color="#eee"/>
      </linearGradient>
      <radialGradient id="g2" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
        <stop offset="0%" stop-color="#eee"/>
        <stop offset="100%" stop-color="#bbb"/>
      </radialGradient>
      <linearGradient id="g3" x1="100%" y1="0%" x2="0%" y2="0%">
        <stop offset="0%" stop-color="#ddd"/>
        <stop offset="100%" stop-color="#ccc"/>
      </linearGradient>
    </defs>
    <g id="clock-face">
      <circle cx="100" cy="100" r="100" stroke="none" fill="url(#g1)"/>
      <circle cx="100" cy="100" r="80" stroke="none" fill="url(#g2)"/>
      <text id="face-name" x="100" y="60" text-anchor="middle" dominant-baseline="middle"></text>
      <circle id="face-ring" cx="100" cy="100" r="99" stroke-width="2" stroke="var(--anlg-name)" fill="none"/>
    </g>
    <g id="pomodoro" fill="none" stroke-width="2.5" stroke-linecap="butt">
      <path id="pa5" visibility="hidden" stroke="var(--pd-inactive-color)"/>
      <path id="pa4" visibility="hidden" stroke="var(--pd-rest-rem-color)"/>
      <path id="pa3" visibility="hidden" stroke="var(--pd-rest-cur-color)"/>
      <path id="pa2" visibility="hidden" stroke="var(--pd-work-rem-color)"/>
      <path id="pa1" visibility="hidden" stroke="var(--pd-work-cur-color)"/>
    </g>    
    <g id="markers" stroke-linecap="round"></g>
    <g id="date">
      <g stroke="#aaa" stroke-width="0.2">
        <rect x="120" y="94" width="20" height="12" rx="2" ry="2" fill="url(#g3)"/>
        <rect x="140" y="94" width="15" height="12" rx="2" ry="2" fill="url(#g3)"/>
        <rect x="155" y="94" width="20" height="12" rx="2" ry="2" fill="url(#g3)"/>
      </g>
      <g stroke="var(--anlg-time)" stroke-width="0.3" fill="var(--anlg-fill)">
        <text id="dow-str"   x="130" y="101" textLength="16" text-anchor="middle" dominant-baseline="middle" lengthAdjust="spacingAndGlyphs"></text>
        <text id="day-str"   x="147.5" y="101" textLength="11" text-anchor="middle" dominant-baseline="middle" lengthAdjust="spacingAndGlyphs"></text>
        <text id="mth-str" x="165" y="101" textLength="16" text-anchor="middle" dominant-baseline="middle" lengthAdjust="spacingAndGlyphs"></text>
      </g>
    </g>
    <g id="hands" stroke-linecap="round">
      <line id="hour-hand"     x1="100" y1="93" x2="100" y2="40" class="hour-hand"/>
      <line id="hour-hand-2"   x1="100" y1="93" x2="100" y2="87" class="hour-hand"/>
      <line id="minute-hand"   x1="100" y1="93" x2="100" y2="5"  class="minute-hand"/>
      <line id="minute-hand-2" x1="100" y1="93" x2="100" y2="85"  class="minute-hand"/>
      <line id="second-hand"   x1="100" y1="93" x2="100" y2="12" class="second-hand"/>
      <line id="second-hand-2" x1="100" y1="93" x2="100" y2="83" class="second-hand"/>
      <circle cx="100" cy="100" r="7" fill="url(#g3)" stroke="#aaa" stroke-width="0.2"/>
    </g>
  </svg>
  <!-- Footer -->
  <footer id="footer">&copy; 2017-2025 Silvino R. | 
    <input type="checkbox" id="pomodoro-checkbox"> <label for="pomodoro-checkbox"><u>P</u>omodoro</label>
    <span class="sound-span hide">&raquo;
      <label class="small" for="work-for-input">Work</label> <input type="number" id="work-for-input" min="1" max="120"> &middot;
      <label class="small" for="rest-for-input">Rest</label> <input type="number" id="rest-for-input" min="1" max="120"> &middot;
      <input type="checkbox" id="sound-checkbox"> <label for="sound-checkbox">&#x266B;</label>
    </span>
    |
    <span id="analog-span" class="show"><input type="checkbox" id="analog-checkbox"> <label for="analog-checkbox"><u>A</u>nalog</label></span>
    <span class="analog-span hide">&raquo; <input type="text" maxlength="25" id="face-name-input" placeholder="Face Name"></span>
  </footer>
  
  <script>
    const months = new Array(
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December' );
    const days = new Array(
      'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday' );
    const CLOCK_REFRESH = 1000;
    const FOOTER_SHOW_DURATION = 1000;
    const FOOTER_HIDE_DURATION = 5000;
    const DEBOUNCE_POLL_RATE = 200; // 25 minutes

    let isVisible = true;
    let isDebug = false;
    const oGTitle = document.title;
    var wakeLockSupported = false;
    let wakeLock = null;
    let clockInterval = null;

    var lastMousePosition = { x: null, y: null };
    var debounceTimeout = null;
    var isMouseMoving = false;
    var footerTimeout = null;
    var isFooterVisible = false;

    let pmdrWorkFor = 25; // default
    let pmdrRestFor = 5; // default

    let audioCtx;
    let tone1 = null;
    let tone2 = null;

    let lastFaviconHour = -1;
    let lastFaviconMins = -1;

    // --- vars as Objects, i.e. getter and setter pair :) ---

    const analogCheckbox = document.getElementById("analog-checkbox");
    Object.defineProperty(window, "isAnalogOn", {
      get() { return analogCheckbox.checked; },
      set(value) { analogCheckbox.checked = Boolean(value); }
    });

    const pomodoroCheckbox = document.getElementById("pomodoro-checkbox");
    Object.defineProperty(window, "isPomodoroOn", {
      get() { return pomodoroCheckbox.checked; },
      set(value) { pomodoroCheckbox.checked = Boolean(value); }
    });

    const soundCheckbox = document.getElementById("sound-checkbox");
    Object.defineProperty(window, "isSoundOn", {
      get() { return soundCheckbox.checked; },
      set(value) { soundCheckbox.checked = Boolean(value); }
    });

    /* ------------ Helpers ------------ */

    function __(msg, level = 3) {
      // Level: 0 = error, 1 = warn, 2 = info, >=3 = log
      if (level <= 0) {
        console.error(msg);
      } else if (level == 1) {
        console.warn(msg);
      } else if (isDebug) {
        if (level == 2) {
          console.info(msg);
        } else {
          console.log(msg);
        }
      }
    }

    // ----- Truthy function -----
    function isTrue(value, fallback = true) {
      if (typeof value === "boolean") return value;
      if (value === undefined || value === null || value === '') return fallback;
      if (typeof value === "string") {
        value = value.trim().toLowerCase();
        if (value.length > 0) value = value[0];
      }
      const trueValues = ["t", "y", "1", 1];
      if (trueValues.includes(value)) return true;
      const falseValues = ["0", 0, "n", "f"];
      if (falseValues.includes(value)) return false;
      if (typeof value === "number") return value !== 0;
      return fallback;
    }

    // // ----- Checkbox, by Id, get if checked -----
    // function getCheckboxCheckedById(checkboxId) {
    //   const checkbox = document.getElementById(checkboxId);
    //   if (checkbox && checkbox.type === 'checkbox') return checkbox.checked;
    //   return false;
    // }

    // ----- Set content by Id -----
    function setContentById(elementId, newValue) {
      const element = document.getElementById(elementId);
      if (element && newValue !== element.textContent) element.textContent = newValue;
    }

    // ----- Update SVG Clock -----
    function updateClock(now) {
      var hours = now.getHours();
      const tHourStr = (hours >= 12) ? "pm" : "am";
      if (hours > 12) hours -= 12;
      const minutes = now.getMinutes();
      const seconds = now.getSeconds();
      const month = now.getMonth();
      const day = now.getDate();
      const weekday = now.getDay();

      if (!isAnalogOn) {
        // Digital

        const hourStr = String(hours).padStart(2, '0');
        const minsStr = String(minutes).padStart(2, '0');
        const secsStr = String(seconds).padStart(2, '0');

        setContentById("hour-str", hourStr);
        setContentById("mins-str", minsStr);
        toggleClassById("time-str", (seconds % 2 === 0), 'even', 'odd');
        setContentById("secs-str", secsStr);
        setContentById("hr12-str", tHourStr);

        const year = now.getFullYear();
        const fullDateStr = days[weekday] + ", " + day + " " + months[month] + " " + year;
        setContentById("date-str", fullDateStr);

      } else {
        // Analog

        const hourAngle = ((hours % 12) * 30) + (minutes * 0.5);
        const minuteAngle = (minutes * 6) + (seconds * 0.1);
        const secondAngle = seconds * 6;

        transformRotateById("hour-hand", hourAngle);
        transformRotateById("hour-hand-2", hourAngle + 180);
        transformRotateById("minute-hand", minuteAngle);
        transformRotateById("minute-hand-2", minuteAngle + 180);
        transformRotateById("second-hand", secondAngle);
        transformRotateById("second-hand-2", secondAngle + 180);

        const monthStr = months[month].substring(0, 3).toUpperCase();
        const weekdayStr = days[weekday].substring(0, 3).toUpperCase();

        setContentById("dow-str", weekdayStr);
        setContentById("day-str", day);
        setContentById("mth-str", monthStr);

      }
    }

    // ----- Transform rotate by Id -----
    function transformRotateById(id, angle) {
      const el = document.getElementById(id);
      if (el) {
        el.setAttribute("transform", `rotate(${angle} 100 100)`);
      }
    }

    // ----- -----
    function setAttributeById(id, attribute, value) {
      const el = document.getElementById(id);
      if (el) {
        el.setAttribute(attribute, value);
      }
    }

    // ----- ----
    function getAttributeById(id, attr) {
      const el = document.getElementById(id);
      if (el) {
        return el.getAttribute(attr);
      }
      return false;
    }

    // ----- Set visibility by Id, html visibility attribute -----
    function setVisibilityById(id, visible = true) {
      let value = visible ? "visible" : "hidden";
      setAttributeById(id, 'visibility', value);
    }

    // ----- Toggle class names -----
    function toggleClassById(id, first, class1, class2) {
      let el = document.getElementById(id);
      if (el) {
        if (first) {
          el.classList.remove(class2);
          el.classList.add(class1);
        } else {
          el.classList.remove(class1);
          el.classList.add(class2);
        }
      }
    }

    // ----- Set visibility by Id, with .show and .hide classes -----
    function setShowClassById(id, visible = true) {
      toggleClassById(id, visible, 'show', 'hide');
    }

    // ----- -----
    function toggleClassByClass(classN, first, class1, class2) {
      const nodes = document.querySelectorAll(`.${classN}`);
      nodes.forEach(el => {
        if (first) {
          el.classList.remove(class2);
          el.classList.add(class1);
        } else {
          el.classList.remove(class1);
          el.classList.add(class2);
        }
      });
    }

    // ----- -----
    function setShowClassByClass(classN, visible = true) {
      toggleClassByClass(classN, visible, 'show', 'hide');
    }    

    // ----- Set X and Width by Id (does not set Y and Height) -----
    function setXAndWidthById(id, x, width) {
      const element = document.getElementById(id);
      if (element) {
        let newX = x.toFixed(3);
        let newWidth = width.toFixed(3);

        setVisibilityById(id, true);  // assume you want to see it
        if (element.getAttribute("x") !== newX) {
          element.setAttribute("x", newX);
        }
        if (element.getAttribute("width") !== newWidth) {
          element.setAttribute("width", newWidth);
        }
      }
    }

    // ----- Draw pomodoro segments -----
    function setRingSegmentPathById(id, startAngle, endAngle) {
      // Convert angles from degrees to radians
      const startRad = (startAngle - 90) * Math.PI / 180; // -90 to start at 12 o'clock
      const endRad = (endAngle - 90) * Math.PI / 180;
      
      const radius = 78;
      
      // Calculate start and end points
      const startX = (100 + radius * Math.cos(startRad)).toFixed(3);
      const startY = (100 + radius * Math.sin(startRad)).toFixed(3);
      const endX = (100 + radius * Math.cos(endRad)).toFixed(3);
      const endY = (100 + radius * Math.sin(endRad)).toFixed(3);
      
      // Determine if we need the large arc flag
      const diff = (endAngle < startAngle) ? (startAngle - endAngle) : (endAngle - startAngle);
      const largeArcFlag = diff > 180 ? "1" : "0";
      
      // Create the SVG path with both large arc and sweep flags
      const pathData =
        `M ${startX} ${startY} ` +
        `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY}`;
      
      // Update the path element

      setVisibilityById(id, true);
      document.getElementById(id).setAttribute("d", pathData);
    }


    // ----- Update Pomodoro progress -----
    function updatePomodoro(now) {
      const minutes = now.getMinutes();
      const seconds = now.getSeconds();
      const maxVal = (pmdrWorkFor + pmdrRestFor) * 60;
      const splitAt = pmdrWorkFor / (pmdrWorkFor + pmdrRestFor);

      var progress = (minutes * 60) + seconds;
      while (progress > maxVal) progress -= maxVal;
      const percentage = progress / maxVal;

      if (isSoundOn) {
        if (Math.round(percentage * 1000) === Math.round(splitAt * 1000)) {
          playSound(tone1);
        }
        if (percentage == 1) {
          playSound(tone2);
        }
      }

      if (!isAnalogOn) {
        // Digital
        const knownSvgWidth = 300;

        if (percentage <= splitAt) {
          let cut = percentage;
          setXAndWidthById("pd1", 0, cut * knownSvgWidth);
          setXAndWidthById("pd2", cut * knownSvgWidth, (splitAt - cut) * knownSvgWidth);
          setVisibilityById("pd3", false);
          setVisibilityById("pd4", false);
          setXAndWidthById("pd5", splitAt * knownSvgWidth, (1 - splitAt) * knownSvgWidth);
        } else {
          let cut = percentage - splitAt;
          setVisibilityById("pd1", false);
          setVisibilityById("pd2", false);
          setXAndWidthById("pd3", splitAt * knownSvgWidth, cut * knownSvgWidth);
          setXAndWidthById("pd4", (splitAt + cut) * knownSvgWidth, (1 - splitAt + cut) * knownSvgWidth);
          setXAndWidthById("pd5", 0, splitAt * knownSvgWidth);
        }
      } else {
        // Analog
        const multiplier = 2;

        if (percentage <= splitAt) {
          setRingSegmentPathById("pa1", 0, percentage * 360);
          setRingSegmentPathById("pa2", percentage * 360, splitAt * 360);
          setVisibilityById("pa3", false);
          setVisibilityById("pa4", false);
          setRingSegmentPathById("pa5", splitAt * 360, 360);
        } else {  
          setVisibilityById("pa1", false);
          setVisibilityById("pa2", false);
          setRingSegmentPathById("pa3", splitAt * 360, percentage * 360);
          setRingSegmentPathById("pa4", percentage * 360, 360);
          setRingSegmentPathById("pa5", 0, splitAt * 360);
        }
      }
    }

    // ----- Update Title of the page (tab in browser) -----
    function updateTitle(now) {
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const title = String(hours).padStart(2, '0') + ":" + String(minutes).padStart(2, '0');
      if (title !== document.title) document.title = title;
    }

    // ----- Update the favicon -----
    function updateFavicon(now) {
      if (now) {
        const hours = now.getHours() % 12;
        const minutes = now.getMinutes();
        if ((minutes == lastFaviconMins) && (hours == lastFaviconHour)) return; // do nothing
        if (hours != lastFaviconHour) lastFaviconHour = hours;
        lastFaviconMins = minutes;

        const svg = 
          '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" stroke-linecap="round" stroke="#876" stroke-width="7.25">' +
          '<circle cx="50" cy="50" r="36.5" fill="none"/>' +
          `<line x1="50" y1="50" x2="${50 + 17.5 * Math.sin(2 * Math.PI * hours / 12)}" y2="${50 - 17.5 * Math.cos(2 * Math.PI * hours / 12)}"/>` +
          `<line x1="50" y1="50" x2="${50 + 22.5 * Math.sin(2 * Math.PI * minutes / 60)}" y2="${50 - 22.5 * Math.cos(2 * Math.PI * minutes / 60)}"/>` +
          '</svg>';
        const encoded = "data:image/svg+xml;base64," + btoa(svg);
        document.getElementById('favicon').href = encoded;
      } else if (lastFaviconMins != -1) {
        document.getElementById('favicon').href = 'favicon.svg';
        lastFaviconMins = -1;
      }
    }

    // ----- Update all handlers -----
    function updateAll() {
      if (isVisible) {
        const now = new Date();
        updateClock(now);
        updateTitle(now);
        updateFavicon(now);
        if (isPomodoroOn) updatePomodoro(now);
      } else {
        if (oGTitle !== document.title) {
          document.title = oGTitle;
          updateFavicon(false);
        }
      }
    }

    // ----- Visibility change handler -----
    async function handleVisibilityChange(event) {
      if (document.visibilityState === "hidden") { 
        isVisible = false;
      } else if (document.visibilityState === "visible") {
        isVisible = true;
      } else {
        isVisible = true;  // what's your fallback choice?
      }

      if (wakeLockSupported) {
        if (isVisible) {
          if (wakeLock === null) {
            try {
              wakeLock = await navigator.wakeLock.request("screen");
              wakeLock.addEventListener("release", () => {
                wakeLock = null;
              });
            } catch (err) {
              __( `Wake Lock Error: ${err.name}, ${err.message}`, 0 );
            }
          }
        } else {
          // !isVisible
          if (wakeLock !== null) {
            wakeLock.release().then(() => {
              wakeLock = null;
            });
          }
        }
      }

      updateAll();
    }

    // ----- Footer bar visibility handler -----
    function handleFooterVisibility(event) {
      const footerElement = document.getElementById('footer');
      if (isFooterVisible) {
        footerElement.classList.remove('show');
        document.body.style.cursor = 'none';
        isFooterVisible = false;
      } else if (isMouseMoving) {
        footerElement.classList.add('show');
        document.body.style.cursor = 'default';
        isFooterVisible = true;
      }
      clearTimeout(footerTimeout);
      footerTimeout = null; // must reset to pass `=== null` test
    }

    // ----- Debounce handler -----
    function handleDebounce(event) {
      if (null !== debounceTimeout) clearTimeout(debounceTimeout);
      debounceTimeout = null;
      isMouseMoving = false;
      if (isFooterVisible) {
        if (null !== footerTimeout) clearTimeout(footerTimeout); // reset
        footerTimeout = setTimeout(handleFooterVisibility, FOOTER_HIDE_DURATION);  
      }
    }

    // ----- Mouse move handler -----
    function handleMouseMove(event) {
      let eventX = (null === event) ? null : event.clientX;
      let eventY = (null === event) ? null : event.clientY;
      if (
        lastMousePosition.x === null ||
        lastMousePosition.y === null ||
        (lastMousePosition.x !== eventX || lastMousePosition.y !== eventY)
      ) {
        isMouseMoving = true;
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(handleDebounce, DEBOUNCE_POLL_RATE);
        lastMousePosition.x = eventX;
        lastMousePosition.y = eventY;
        if (!isFooterVisible && footerTimeout === null) {
          footerTimeout = setTimeout(handleFooterVisibility, FOOTER_SHOW_DURATION);  
        }
      }
    }

    // ----- Key event handler -----
    function handleKeyEvent(event) {
      handleMouseMove(null);
    }

    // ----- Double click handler -----
    function handleDoubleClick(event) {
      if (event.target.closest('footer') !== null) return;
      if (!document.fullscreenElement) {
        let element = document.documentElement;
        if (element.requestFullscreen) {
          element.requestFullscreen();
        } else if (element.webkitRequestFullscreen) {
          element.webkitRequestFullscreen();
        } else {
          __("Fullscreen API not supported", 0);
        }      
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        }
      }
    }

    // ----- Handle Pomodoro activation -----
    function handlePomodoroSwitchChange(event) {
      // this.checked is not needed, since `isPomodoroOn` getter will get that
      if (isPomodoroOn) {
        safeSetItem("isPomodoroOn", isPomodoroOn);
      } else {
        localStorage.removeItem("isPomodoroOn");
      }
      if (isPomodoroOn) {
        let now = new Date();
        updatePomodoro(now);
      } else {
        for (let i = 1; i <= 5; i++) {
          setVisibilityById("pd"+i, false);
          setVisibilityById("pa"+i, false);
        }
      }
      setShowClassByClass('sound-span', isPomodoroOn);
    }

    // ----- -----
    function getValueById(id) {
      const el = document.getElementById(id);
      if (el) {
        return el.value;
      } else
        return false;
    }

    // ----- -----
    function handlePomodoroValueChange(event) {
      const savedWork = safeGetItem('pomodoroWorkFor', false);
      const savedRest = safeGetItem('pomodoroRestFor', false);
      const wantedWork = getValueById('work-for-input');
      const wantedRest = getValueById('rest-for-input');

      if ((savedWork != wantedWork) || (savedRest != wantedRest)) {
        if (wantedWork && (savedWork != wantedWork)) {
          safeSetItem('pomodoroWorkFor', wantedWork);
          pmdrWorkFor = Number(wantedWork);
        }
        if (wantedRest && (savedRest != wantedRest)) {
          safeSetItem('pomodoroRestFor', wantedRest);
          pmdrRestFor = Number(wantedRest);
        }
        let now = new Date();
        updatePomodoro(now);
      }
    }

    // ----- -----
    function handleAnalogChange(event) {
      activateAnalog(isAnalogOn);
    }

    // ----- -----
    async function handleSoundChange(event) {
      try {
        if (this.checked) {
          // user gesture: safe to create/resume and load sounds
          audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
          if (audioCtx.state === "suspended") await audioCtx.resume();
          if (!(tone1 instanceof AudioBuffer)) tone1 = await loadSound("tone1.mp3");
          if (!(tone2 instanceof AudioBuffer)) tone2 = await loadSound("tone2.mp3");
        } else {
          // turn sound off
          if (audioCtx && audioCtx.state !== "closed") await audioCtx.suspend();
        }
      } catch (err) {
        __(`Sound toggle failed: ${err.name} ${err.message}`, 0);
      }
    }

    // ----- -----
    function handelFaceNameChange(event) {
      const faceName = this.value;
      document.getElementById("face-name").textContent = faceName;
      if (faceName === "") {
        localStorage.removeItem("faceName");
      } else {
        safeSetItem("faceName", faceName);
      }

      // fake keep alive
      handleDebounce();
      handleMouseMove(null);  
    }

    // ----- -----
    function isTypingInInput(event) {
      const target = event.target;
      return target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable;
    }    

    // ----- -----
    function handleKeyPress(event) {
      if (!event) return;
      const eventKey = event.key.toLowerCase();
      const isNotTII = !isTypingInInput(event);

      if ((eventKey === 'p') && isNotTII) {
        const el = document.getElementById('pomodoro-checkbox');
        if (el) {
          el.checked = !el.checked;
        }
        handlePomodoroSwitchChange(event);
      }

      if (((eventKey === 'a') || (eventKey === 'd')) && isNotTII) {
        const el = document.getElementById('analog-checkbox');
        if (el) {
          el.checked = !el.checked;
        }
        handleAnalogChange(event);
      }

      if (isPomodoroOn && (eventKey === 's') && isNotTII) {
        const el = document.getElementById('sound-checkbox');
        if (el) {
          el.checked = !el.checked;
        }
        handleSoundChange(event);
      }
    }

    // ----- -----
    function safeSetItem(key, value) {
      try {
        localStorage.setItem(key, value);
      } catch (err) {
        __(`localStorage.setItem: ${err.name}, ${err.message}`, 0);
      }
    }

    // ----- -----
    function safeGetItem(key, fallback = false) {
      var ret;
      try {
        ret = localStorage.getItem(key);
      } catch (err) {
        __(`localStorage.setItem: ${err.name}, ${err.message}`, 0);
        return fallback;
      }
      if (null === ret) return fallback; // not there, fallback
      return ret;
    }

    // ----- -----
    function processConfig(config) {
      if (typeof config !== 'object') return;

      const faceName = config['faceName'];
      if (faceName) {
        document.getElementById("face-name").textContent = faceName;
        document.getElementById("face-name-input").value = faceName;
      }

      const wantsAnalogOn = isTrue(config['isAnalogOn'], false);
      if (wantsAnalogOn) isAnalogOn = true;

      const wantsPomodoroOn = isTrue(config['isPomodoroOn'], false);
      isPomodoroOn = wantsPomodoroOn;
      setShowClassByClass('sound-span', wantsPomodoroOn);

      const pomodoroWorkFor = Number(config['pomodoroWorkFor']);
      if (!Number.isNaN(pomodoroWorkFor)) pmdrWorkFor = pomodoroWorkFor;
      const pomodoroRestFor = Number(config['pomodoroRestFor']);
      if (!Number.isNaN(pomodoroRestFor)) pmdrRestFor = pomodoroRestFor;

      setAttributeById('work-for-input', 'value', pmdrWorkFor);
      setAttributeById('rest-for-input', 'value', pmdrRestFor);
    }

    // ----- Initialisation code -----
    async function performInit() {
      let config = {};
      config['ping'] = Date.now(); // need this otherwise an empty localStorage causes issues
      try {
        if (localStorage) {
          for (let i = 0; i < localStorage.length; i++) {
            let key = localStorage.key(i);
            config[key] = localStorage.getItem(key);
          }
        }
      } catch (err) {
        __(err, 0);
      }

      const isInitialised = safeGetItem('clockInitialised', false);
      if (false == isInitialised) {
        __('Loading config from file');
        fetch("config.json")
          .then(response => {
            return response.json();
          })
          .then(settings => {
            // Store each root level setting in localStorage
            Object.keys(settings).forEach(key => {
              safeSetItem(key, settings[key]);
              config[key] = settings[key];
            });
            processConfig(config);
            safeSetItem("clockInitialised", true);
          })
          .catch(err => {
            __(`Error loading settings: ${err.name} ${err.message}`, 0);
            safeSetItem("clockInitialised", true);
            return error
          });
      } else {
        processConfig(config);
      }
      return Promise.resolve();
    }

    // ----- Swap modes function, digital<->analog -----
    function activateAnalog(active) {
      if (active) {
        document.body.classList.remove("digital");
        document.body.classList.add("analog");
        setShowClassById("digital-clock", false);
        setShowClassById("analog-clock", true);
        safeSetItem("isAnalogOn", true);
        setShowClassByClass('analog-span', true);
        isAnalogOn = true;
      } else {
        document.body.classList.remove("analog");
        document.body.classList.add("digital");
        setShowClassById("analog-clock", false);
        setShowClassById("digital-clock", true);
        localStorage.removeItem("isAnalogOn");
        setShowClassByClass('analog-span', false);
        isAnalogOn = false;
      }
      updateAll();
    }

    // ----- -----
    function setSvgLineAttributes(line, x1, y1, x2, y2, className, strokeWidth, rotate = 0) {
      line.setAttribute("x1", x1);
      line.setAttribute("y1", y1);
      line.setAttribute("x2", x2);
      line.setAttribute("y2", y2);
      line.setAttribute("class", className);
      line.setAttribute("stroke-width", strokeWidth);
      if (rotate !== 0) {
        line.setAttribute("transform", `rotate(${rotate} 100 100)`);
      }
    }

    // ----- -----
    function drawAnalogClockFace() {
      const svg = document.getElementById('analog-clock');
      const markers = document.getElementById('markers');

      // 12 o'clock position
      for (let i = 0; i < 2; i++) {
        let line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        setSvgLineAttributes(line, 100 + (i == 0 ? -2 : 2), 4.75, 100 + (i == 0 ? -2 : 2), 18, "hour-marker", 2);
        markers.appendChild(line);
      }

      // 1 to 11 o'clock positions
      for (let i = 1; i < 12; i++) {
        let line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        setSvgLineAttributes(line, 100, 12, 100, 18, "hour-marker", 2, i * 30);
        markers.appendChild(line);
      }

      // 1 to 11 o'clock numbers
      for (let i = 1; i < 12; i++) {
        let text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", "100");
        text.setAttribute("y", "7");
        text.setAttribute("class", "face-seconds");
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("dominant-baseline", "middle");
        text.textContent = i * 5;        
        text.setAttribute("transform", `rotate(${i * 30} 100 100)`);
        markers.appendChild(text);
      }

      // 5 minute markers
      for (let i = 0; i < 60; i++) {
        if (i % 5 !== 0) {
          let line = document.createElementNS("http://www.w3.org/2000/svg", "line");
          setSvgLineAttributes(line, 100, 5, 100, 10, "minute-marker", 1, i * 6);
          markers.appendChild(line);
        }
      }
    }

    // ----- -----
    async function loadSound(url) {
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      const res = await fetch(url); // same-origin fetch is fine
      if (!res.ok) {
        __(`loadSound error: HTTP ${res.status}`, 0);
        return null;
      }

      const arrayBuf = await res.arrayBuffer();

      let decoded;
      try {
        decoded = await audioCtx.decodeAudioData(arrayBuf);
      } catch {
        decoded = await new Promise((resolve, reject) =>
          audioCtx.decodeAudioData(arrayBuf, resolve, reject)
        );
      }
      if (!(decoded instanceof AudioBuffer)) {
        __('loadSound error: Decoded result is not an AudioBuffer', 0);
        return null;
      }
      return decoded;
    }

    // ----- -----
    function playSound(buffer) {
      if (!(buffer instanceof AudioBuffer) || !audioCtx) return;
      const src = audioCtx.createBufferSource();
      src.buffer = buffer;                 // must be an AudioBuffer
      src.connect(audioCtx.destination);
      src.start();                          // start immediately
      return src;
    }

    /* ============ Core / Main code ============ */

    /**
     * This get's run on first load
     */
    document.addEventListener("DOMContentLoaded", function() {

      const params = new URLSearchParams(window.location.search);
      const debugValue = params.get("debug");
      if (debugValue !== null) {
        isDebug = isTrue(debugValue, true);
      }
      if (isDebug) __('*** DEBUG ON ***');

      performInit();

      const analogValue = params.get("analog");
      if (analogValue !== null) {
        isAnalogOn = isTrue(analogValue, true);
      }
      if (isAnalogOn) activateAnalog(true); // start the clock works, incl. saving state in localStorage
 
      drawAnalogClockFace();

      updateAll(); // Initialize clock immediately, first time run

      if ("wakeLock" in navigator) {
        wakeLockSupported = true;
        handleVisibilityChange(null); // first time run, fake it
      } else {
        __("Screen Wake Lock API is not supported on this browser", 1);
      }

      document.addEventListener('visibilitychange', handleVisibilityChange);
      window.addEventListener('resize', handleVisibilityChange);
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('keydown', handleKeyEvent);
      document.addEventListener('keyup', handleKeyEvent);
      document.body.addEventListener('dblclick', handleDoubleClick);

      document.getElementById('pomodoro-checkbox').addEventListener('change', handlePomodoroSwitchChange);
      document.getElementById('analog-checkbox').addEventListener('change', handleAnalogChange);
      document.getElementById('sound-checkbox').addEventListener('change', handleSoundChange);
      document.getElementById('face-name-input').addEventListener('input', handelFaceNameChange);
      document.getElementById('work-for-input').addEventListener('input', handlePomodoroValueChange);
      document.getElementById('rest-for-input').addEventListener('input', handlePomodoroValueChange);

      document.addEventListener('keydown', handleKeyPress);

      // START THE CLOCK!!
      clockInterval = setInterval(updateAll, CLOCK_REFRESH); // Start the update loop
    });
  </script>
</body>
</html>
